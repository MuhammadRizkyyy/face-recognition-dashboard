<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Face Recognition Attendance Dashboard</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
      }

      header {
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        margin-bottom: 30px;
        text-align: center;
        position: relative;
      }

      h1 {
        color: #667eea;
        font-size: 2.5em;
        margin-bottom: 10px;
      }

      .subtitle {
        color: #666;
        font-size: 1.1em;
      }

      .live-indicator {
        position: absolute;
        top: 20px;
        right: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
        background: #10b981;
        color: white;
        padding: 8px 15px;
        border-radius: 20px;
        font-size: 0.9em;
        font-weight: bold;
      }

      .live-dot {
        width: 8px;
        height: 8px;
        background: white;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
        transition: transform 0.3s;
      }

      .stat-card:hover {
        transform: translateY(-5px);
      }

      .stat-number {
        font-size: 3em;
        font-weight: bold;
        color: #667eea;
        margin-bottom: 10px;
      }

      .stat-label {
        color: #666;
        font-size: 1.1em;
      }

      .controls {
        background: white;
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
      }

      select,
      input,
      button {
        padding: 12px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
        outline: none;
      }

      button {
        background: #667eea;
        color: white;
        border: none;
        cursor: pointer;
        font-weight: bold;
        transition: background 0.3s;
      }

      button:hover {
        background: #5568d3;
      }

      .refresh-btn {
        background: #10b981;
      }

      .refresh-btn:hover {
        background: #059669;
      }

      .table-container {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        overflow-x: auto;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      th {
        background: #667eea;
        color: white;
        padding: 15px;
        text-align: left;
        font-weight: 600;
        position: sticky;
        top: 0;
      }

      td {
        padding: 15px;
        border-bottom: 1px solid #e0e0e0;
      }

      tr:hover {
        background: #f8f9fa;
      }

      .status-badge {
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9em;
      }

      .status-hadir {
        background: #d1fae5;
        color: #065f46;
      }

      .confidence-badge {
        background: #dbeafe;
        color: #1e40af;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.85em;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
      }

      .no-data {
        text-align: center;
        padding: 60px;
        color: #999;
        font-size: 1.2em;
      }

      .new-entry {
        animation: highlight 2s ease;
      }

      @keyframes highlight {
        0% {
          background: #fef3c7;
        }
        100% {
          background: transparent;
        }
      }

      .last-update {
        color: #999;
        font-size: 0.9em;
        text-align: right;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="live-indicator">
          <div class="live-dot"></div>
          LIVE
        </div>
        <h1>üì∏ Face Recognition Attendance System</h1>
        <p class="subtitle">Real-time Attendance Monitoring Dashboard</p>
      </header>

      <div class="stats" id="stats">
        <div class="stat-card">
          <div class="stat-number" id="totalStudents">0</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="presentToday">0</div>
          <div class="stat-label">Present Today</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="totalCourses">0</div>
          <div class="stat-label">Active Courses</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="attendanceRate">0%</div>
          <div class="stat-label">Attendance Rate</div>
        </div>
      </div>

      <div class="controls">
        <select id="courseFilter">
          <option value="">All Courses</option>
        </select>
        <input type="date" id="dateFilter" />
        <button onclick="filterData()">üîç Filter</button>
        <button class="refresh-btn" onclick="loadData()">üîÑ Refresh</button>
      </div>

      <div class="table-container">
        <h2 style="margin-bottom: 20px">üìã Attendance Records</h2>
        <div id="tableContent" class="loading">Loading data...</div>
        <div class="last-update" id="lastUpdate"></div>
      </div>
    </div>

    <script>
      // API Configuration
      const API_URL = "http://localhost:3000/api";
      let lastAttendanceCount = 0;
      let previousData = [];

      // Set today's date as default
      document.getElementById("dateFilter").valueAsDate = new Date();

      async function loadData() {
        try {
          // Load statistics
          const statsResponse = await fetch(`${API_URL}/stats`);
          const statsData = await statsResponse.json();

          if (statsData.success) {
            displayStats(statsData.data);
          }

          // Load attendances
          const date = document.getElementById("dateFilter").value;
          const course = document.getElementById("courseFilter").value;

          let url = `${API_URL}/attendances?`;
          if (date) url += `date=${date}&`;
          if (course) url += `courseCode=${course}`;

          const attendanceResponse = await fetch(url);
          const attendanceData = await attendanceResponse.json();

          if (attendanceData.success) {
            displayTable(attendanceData.data);

            // Check for new entries
            if (
              attendanceData.count > lastAttendanceCount &&
              lastAttendanceCount > 0
            ) {
              playNotificationSound();
            }
            lastAttendanceCount = attendanceData.count;
            previousData = attendanceData.data;
          }

          // Load courses for filter
          const coursesResponse = await fetch(`${API_URL}/courses`);
          const coursesData = await coursesResponse.json();

          if (coursesData.success) {
            loadCourses(coursesData.data);
          }

          // Update last update time
          updateLastUpdateTime();
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById(
            "tableContent"
          ).innerHTML = `<div class="no-data">‚ùå Error: ${error.message}<br>Make sure API server is running on http://localhost:3000</div>`;
        }
      }

      function displayStats(stats) {
        animateNumber("totalStudents", stats.totalStudents || 0);
        animateNumber("presentToday", stats.presentToday || 0);
        animateNumber("totalCourses", stats.totalCourses || 0);
        document.getElementById("attendanceRate").textContent =
          stats.attendanceRate || "0%";
      }

      function animateNumber(elementId, targetValue) {
        const element = document.getElementById(elementId);
        const currentValue = parseInt(element.textContent) || 0;

        if (currentValue === targetValue) return;

        const duration = 500;
        const steps = 20;
        const increment = (targetValue - currentValue) / steps;
        let current = currentValue;
        let step = 0;

        const timer = setInterval(() => {
          step++;
          current += increment;

          if (step >= steps) {
            element.textContent = targetValue;
            clearInterval(timer);
          } else {
            element.textContent = Math.round(current);
          }
        }, duration / steps);
      }

      function displayTable(data) {
        if (data.length === 0) {
          document.getElementById("tableContent").innerHTML =
            '<div class="no-data">üì≠ No attendance records found</div>';
          return;
        }

        const html = `
          <table>
            <thead>
              <tr>
                <th>Time</th>
                <th>NPM</th>
                <th>Student Name</th>
                <th>Course</th>
                <th>Status</th>
                <th>Confidence</th>
                <th>Method</th>
              </tr>
            </thead>
            <tbody>
              ${data
                .map((record, index) => {
                  const isNew =
                    index === 0 &&
                    previousData.length > 0 &&
                    record._id !== previousData[0]._id;
                  return `
                  <tr class="${isNew ? "new-entry" : ""}">
                    <td>${formatTime(record.checkInTime)}</td>
                    <td><strong>${record.npm}</strong></td>
                    <td>${record.studentName}</td>
                    <td>${record.courseCode}${
                    record.courseName ? " - " + record.courseName : ""
                  }</td>
                    <td><span class="status-badge status-hadir">${
                      record.status
                    }</span></td>
                    <td><span class="confidence-badge">${
                      record.confidence
                        ? record.confidence.toFixed(1) + "%"
                        : "N/A"
                    }</span></td>
                    <td>${record.recognitionMethod}</td>
                  </tr>
                `;
                })
                .join("")}
            </tbody>
          </table>
        `;

        document.getElementById("tableContent").innerHTML = html;
      }

      function loadCourses(courses) {
        const select = document.getElementById("courseFilter");
        const currentValue = select.value;

        select.innerHTML = '<option value="">All Courses</option>';

        courses.forEach((course) => {
          const option = document.createElement("option");
          option.value = course.courseCode;
          option.textContent = `${course.courseCode} - ${course.courseName}`;
          select.appendChild(option);
        });

        select.value = currentValue;
      }

      function filterData() {
        lastAttendanceCount = 0; // Reset to avoid notification on filter
        loadData();
      }

      function formatTime(dateString) {
        const date = new Date(dateString);
        return date.toLocaleString("id-ID", {
          day: "2-digit",
          month: "short",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
      }

      function updateLastUpdateTime() {
        const now = new Date();
        document.getElementById(
          "lastUpdate"
        ).textContent = `Last updated: ${now.toLocaleTimeString("id-ID")}`;
      }

      function playNotificationSound() {
        // Optional: Play notification sound for new attendance
        const audio = new Audio(
          "data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBjGH0fPTgjMGHm7A7+OZRQ0PVqzn77BdGAo+ltryxnElBywAoNnzwmwhBi18zu/glkMNDliq5vCsXBkKPJPY88p1JQUVZ7zt5KFLEQxOpOLzumEcBzo="
        );
        audio.volume = 0.3;
        audio.play().catch((e) => console.log("Audio play failed:", e));
      }

      // Auto-refresh every 5 seconds for real-time updates
      setInterval(loadData, 5000);

      // Initial load
      loadData();

      // Prevent form submission on Enter key
      document.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          filterData();
        }
      });
    </script>
  </body>
</html>
